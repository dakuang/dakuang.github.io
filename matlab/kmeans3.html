<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Accelerate Matlab K-means with Simple Patches</title>
</head>

<body>
<p><font size="+3" face="Arial, Helvetica, sans-serif">Accelerate Matlab K-means with Simple Patches</font></p>
<p><em><font size="+1">Da Kuang</font></em> </p>
<hr />
<p><font size="+2" face="Arial, Helvetica, sans-serif">Software Description </font></p>
<p>This page provides tools for accelerating the <font face="Courier New, Courier, monospace"><a href="http://www.mathworks.com/help/toolbox/stats/kmeans.html" target="_blank">kmeans</a></font> function in Matlab. K-means is by far the most widely used clustering algorithm in data analysis. The Matlab implementation of K-means (available in the Statistics Toolbox) is frequently used for research and academic purposes. However, it has difficulty in efficiency when dealing with large and high-dimensional data sets. The tools on this page are patch files and scripts for applying these patches to the original <font face="Courier New, Courier, monospace">kmeans</font> function in your Matlab product.</p>
<p>The new script generated from the patches can accelerate Matlab <font face="Courier New, Courier, monospace">kmeans</font> by several orders of magnitude on large data sets. For historical reasons (the naming on my own laptop), it is named as <font face="Courier New, Courier, monospace">kmeans3</font>. Its features include:</p>
<p>1. <font face="Courier New, Courier, monospace">kmeans3</font> may reduce the running time of <font face="Courier New, Courier, monospace">kmeans</font> from several hours to a minute. Benchmarking results on text and image data sets are listed at the bottom of this page (please also see the important note about the &quot;batch&quot; and &quot;online&quot; phases of K-means).<br>
  2. <font face="Courier New, Courier, monospace">kmeans3</font> has the same input and output parameters as <font face="Courier New, Courier, monospace">kmeans</font>. Any use of <font face="Courier New, Courier, monospace">kmeans</font> can be substituted by <font face="Courier New, Courier, monospace">kmeans3</font> easily.<br>
  3. Mathematically, clustering results from <font face="Courier New, Courier, monospace">kmeans</font> and <font face="Courier New, Courier, monospace">kmeans3</font> are always the same, when they have the same initialization. (Numerical rounding error, which is intrinsic for any computer, may slightly change the clustering results. Please see more comments below.)<br>
  4
  .
<font face="Courier New, Courier, monospace">kmeans3</font> also fixes several bugs in the original <font face="Courier New, Courier, monospace">kmeans</font> function.</p>
<hr>
<p><font size="+2" face="Arial, Helvetica, sans-serif">Download</font></p>
<p>Please choose the archive file to download <strong>according to your Matlab version:</strong></p>
<p><font face="Courier New, Courier, monospace">R2009a: [<a href="kmeans/2009a.zip">zip</a>]<br>
R2009b: [<a href="kmeans/2009b.zip">zip</a>]<br>
R2010a: [<a href="kmeans/2010a.zip">zip</a>]<br>
R2010b: [<a href="kmeans/2010b.zip">zip</a>]<br>
R2011a: [<a href="kmeans/2011a.zip">zip</a>]<br>
R2011b: [<a href="kmeans/2011b.zip">zip</a>]</font></p>
<p><strong>Software requirement:</strong> Matlab and the Statistics Toolbox. The current shell script for applying the patches is written for Unix/Linux only. For Windows users, software similar to the Unix <font face="Courier New, Courier, monospace">patch</font> exist, and please read the <font face="Courier New, Courier, monospace">.sh</font> file in your downloaded archive for details of how to apply the patches (note that internal directory structures for a particular version of Matlab are the same across Windows and Unix/Linux).</p>
<p><strong>The following files are contained in each archive</strong> (take R2009a version for example):</p>
<p><font face="Courier New, Courier, monospace">kmeans_2009a_patch.txt</font> - The patch file to be applied to the original <font face="Courier New, Courier, monospace">kmeans</font> function. It is generated by Unix <font face="Courier New, Courier, monospace">diff</font>. <br>
  <font face="Courier New, Courier, monospace">patch_2009a.sh</font> - The shell script for retrieving the original <font face="Courier New, Courier, monospace">kmeans</font> function, applying the patch file to generate <font face="Courier New, Courier, monospace">kmeans3</font> function, and copying auxiliary files.<br>
  <font face="Courier New, Courier, monospace">dist2.m</font> - Computes the distances between a set of data points and a set of centroids. It is modified from the original function written by <a href="http://research.microsoft.com/en-us/um/people/cmbishop/prml/" target="_blank">Christopher Bishop</a>, with slight performance improvement. <br>
  <font face="Courier New, Courier, monospace">test_kmeans_patch.m</font> - A simple script for testing the equivalence between the clustering results of <font face="Courier New, Courier, monospace">kmeans</font> and <font face="Courier New, Courier, monospace">kmeans3</font>.<br>
  <font face="Courier New, Courier, monospace">iris.data</font> - The famous Fisher Iris data set, used by the test script.</p>
<p><strong>Please report any bugs to the following email. Suggestions are also welcome!</strong><br>
  (before @) <font face="Courier New, Courier, monospace">da.kuang</font><br>
(after @) <font face="Courier New, Courier, monospace">cc.gatech.edu</font></p>
<hr>
<p><font size="+2" face="Arial, Helvetica, sans-serif">Usage</font></p>
<p>Run the <font face="Courier New, Courier, monospace">.sh</font> script, and follow the prompt to input the Matlab directory. After the patch is successfully applied, <font face="Courier New, Courier, monospace">kmeans3</font> is located in your current directory. Use <font face="Courier New, Courier, monospace">kmeans3</font> instead of <font face="Courier New, Courier, monospace">kmeans</font> in any of your applications (because the interfaces are all the same except the function names), and see the performance boost! </p>
<p>For example: </p>
<p><font face="Courier New, Courier, monospace">Please enter your MATLAB installation path: <font color="#FF0000">/usr/local/MATLAB/R2011b/</font></font> </p>
<p>Note that this path should include <font face="Courier New, Courier, monospace">bin</font> and <font face="Courier New, Courier, monospace">toolbox</font>  as two subdirectories (among others).</p>
<p>You may want to run the script <font face="Courier New, Courier, monospace">test_kmeans_patch</font> to make sure that the patch is successful. A message &quot;<font face="Courier New, Courier, monospace">Test passed!</font>&quot; should be displayed. </p>
<hr>
<p><font size="+2" face="Arial, Helvetica, sans-serif">Why Matlab K-means?</font></p>
<p>Although K-means is a quite standard clustering method, the results of K-means clustering are often ambiguous in practice. The reason is that a slight change to its implementation may greatly alter the final output. For example, how to initialize the centroids, how many iterations, whether to include additional online-update phase...: All of these are choices one has to make when implementing this algorithm. Thus, to accelerate K-means in Matlab, I chose not to implement my own from scratch, but modified the original <font face="Courier New, Courier, monospace">kmeans</font> function in Matlab so that a user will not see surprisingly different results when using <font face="Courier New, Courier, monospace">kmeans3</font>.</p>
<p>The clustering results of <font face="Courier New, Courier, monospace">kmeans</font> and <font face="Courier New, Courier, monospace">kmeans3</font> should be the same mathematically. However, a user should notice that they might be different due to numerical rounding error. The majority of computation required in K-means is the computation of an n-by-k distance matrix D, where n is the number of data points and k is the number of clusters requested. This matrix contains all the pairwise distances between a data point (x_i) and a centroid (c_j). The way to compute D in the original <font face="Courier New, Courier, monospace">kmeans</font> in Matlab is very slow. For example, to compute the Euclidean distance between two vectors of length p, it sequentially sums over the p variables. In <font face="Courier New, Courier, monospace">kmeans3</font>, another way to compute D is used, according to the following fact:</p>
<p>|x_i - c_j|^2 = |x_i|^2 - 2 &lt;x_i, c_j&gt; + |c_j|^2  (*)</p>
<p>Here, the quantity &lt;x_i, c_j&gt; for all the i's and j's can be computed at once by the matrix multiplication X * C', where X has size n-by-p and C has size k-by-p. This computation is fast because matrix-matrix multiplication is BLAS3 computation and has efficient use of CPU cache. Just note that the numerical results of the left-hand and right-hand sides of (*) may be different. (please refer to I. T. Nabney, <em>NETLAB: Algorithms for Pattern Recognition</em>, page 24)</p>
<p>Matlab K-means has some unique advantages over the K-means implementation in other statistical packages.</p>
<p>First, after each iteration, it detects which clusters have added or removed data points, and only updates the centroid vectors for those clusters. The j-th column of the distance matrix D contains the distances between the j-th cluster centroid and all the data points. Only the columns of D that correspond to changed clusters are updated after each iteration. This saves a lot of computation that would be wasted otherwise.</p>
<p>Second, Matlab <font face="Courier New, Courier, monospace">kmeans</font> has a batch-update phase and an additional online-update phase. The batch-update phase follows the description of K-means in most textbooks, iteratively updating the cluster assignments (determined by the distance matrix D) and computing the cluster centroids C. In the online-update phase, a data point is moved from one cluster to another if such a move reduces the objective function of K-means, and this procedure is done for every data point in a cyclic manner until moving any single data point to a different cluster increases the objective function. Both phases are used by default in Matlab <font face="Courier New, Courier, monospace">kmeans</font>, but the online-update phase can be turned off.  For more details, please refer to R. O. Duda, P. E. Hart, and D. G. Stork, <em>Pattern Classification (2nd ed.)</em>, Chapter 10.8.</p>
<p>Although K-means with the online-update phase can potentially have much better clustering quality, it is  much more time-consuming than the batch-update phase. With the acceleration in <font face="Courier New, Courier, monospace">kmeans3</font>, the time cost of both phases can be reduced by several orders of magnitude, as shown below. </p>
<hr>
<p><font size="+2" face="Arial, Helvetica, sans-serif">Benchmarking Results </font></p>
<p><font face="Courier New, Courier, monospace">kmeans</font> and <font face="Courier New, Courier, monospace">kmeans3</font> are run for 5 times starting from different initializations. In each run, we keep the initialization the same for <font face="Courier New, Courier, monospace">kmeans</font> and <font face="Courier New, Courier, monospace">kmeans3</font>. The data sets used for benchmerking are listed below:</p>
<p><a href="http://www.daviddlewis.com/resources/testcollections/reuters21578/" target="_blank">Reuters-21578</a>: A text data set widely used in data mining. We choose the largest 20 groups. The input matrix is sparse, with size 7800 (number of documents) x 18685 (number of terms).<br>
CMU PIE: coming soon... </p>
<p>All the benchmarking  is done on a Linux server with two Intel Xeon X5550 quad-core CPUs and 24GB memory. The average running time of different scripts/settings is plotted in logarithmic scale: </p>
<p><img src="kmeans/bench.png" alt="Comparison of kmeans and kmeans3"> </p>
<hr>
<p>
Last modified: May 15, 2013 </p>
</body>
</html>
